<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GDPR Compliance Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    html,body { height:100%; margin:0; font-family:system-ui,Arial,sans-serif; background:#fff; }
    #app { display:flex; height:100vh; }
    #map { flex:1; background:#ffffff; }
    #panel { width:380px; border-left:1px solid #ddd; padding:12px; box-sizing:border-box; }
    .jur-card { border:1px solid #eee; border-radius:6px; padding:8px; margin-bottom:10px; background:#fafafa; }
    .controls { margin-bottom:8px; display:flex; gap:8px; flex-wrap:wrap; }
    button { padding:8px 10px; border-radius:6px; border:none; background:#222; color:#fff; cursor:pointer; }
    button.active { background:#007bff; }
    .legend { margin-top:10px; }
    .legend-item { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .swatch { width:18px; height:14px; border-radius:3px; border:1px solid #999; display:inline-block; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border:1px solid #eee; padding:6px; font-size:13px; text-align:left; }
    .country { cursor:pointer; }
  </style>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <div id="panel">
    <h2 style="margin:6px 0 12px 0;">GDPR Compliance Map</h2>

    <div class="controls">
      <button id="toggleCompare">Compare Mode: OFF</button>
      <button id="clearAll">Clear</button>
    </div>

    <div id="details" class="jur-card">Click a country to view details (single-select mode), or toggle Compare Mode to select multiple.</div>

    <div class="legend" id="legend"></div>

    <h3 style="margin-top:14px">Compare</h3>
    <div id="compareArea">No jurisdictions selected.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
// --- Mock compliance data (replace with your actual data later) ---
const complianceData = {
  "France": { authority:"CNIL", law:"GDPR + French Data Protection Act", fines:"Up to €20M or 4%", transfers:"SCCs, adequacy", note:"Strong enforcement history" },
  "Germany": { authority:"BfDI / State DPAs", law:"GDPR + BDSG", fines:"Up to €20M or 4%", transfers:"SCCs; state rules", note:"State-level variation" },
  "United Kingdom": { authority:"ICO", law:"UK GDPR + DPA 2018", fines:"Up to £17.5M or 4%", transfers:"UK SCCs", note:"Post-Brexit adequacy" }
};

// --- Highlight colours (in order) ---
const palette = ["#9b1e66","#e1345c","#e7450f","#f7a723","#ffd900","#4f9f35","#00a191"];

// --- State ---
let compareMode = false;
let assigned = {};
let assignedOrder = [];
let layerByName = {};
let currentSingle = null;

// --- Map Setup ---
const map = L.map('map', {
  zoomControl:false,
  doubleClickZoom:false,
  scrollWheelZoom:false,
  touchZoom:false,
  boxZoom:false,
  keyboard:false,
  dragging:true,
  worldCopyJump:false,
  maxBounds:[[-40,-180],[75,180]],
  maxBoundsViscosity:1.0
}).setView([25,10],2);

function baseStyle(){
  return { color:'#222', weight:1, fillColor:'#fafafa', fillOpacity:1, className:'country', interactive:true };
}
function setLayerColor(layer, color){
  layer.setStyle({ fillColor: color, fillOpacity:1, color:'#222', weight:1 });
  if (layer.bringToFront) layer.bringToFront();
}
function resetLayer(layer){ layer.setStyle(baseStyle()); }

// --- Load your local GeoJSON ---
fetch('countries.geojson')
  .then(r => r.json())
  .then(data => {
    data.features = data.features.filter(f => f.properties.ADMIN !== 'Antarctica');

    L.geoJSON(data, {
      style: baseStyle,
      onEachFeature: (feature, layer) => {
        const name = feature.properties.ADMIN;
        layerByName[name] = layer;
        layer.on('click', () => handleClick(name));
        layer.on('mouseover', () => {
          if (!compareMode && layer !== currentSingle && !assigned[name])
            layer.setStyle({ fillOpacity:0.85 });
        });
        layer.on('mouseout', () => {
          if (!compareMode && layer !== currentSingle && !assigned[name])
            resetLayer(layer);
        });
      }
    }).addTo(map);
  });

// --- Interaction logic ---
function handleClick(name){
  const layer = layerByName[name];
  if (!layer) return;

  if (compareMode) {
    // toggle compare selection
    if (assigned[name]) {
      delete assigned[name];
      assignedOrder = assignedOrder.filter(n => n !== name);
      resetLayer(layer);
    } else {
      const used = new Set(Object.values(assigned));
      const color = palette.find(c => !used.has(c));
      if (!color) return alert('Max selections reached.');
      assigned[name] = color;
      assignedOrder.push(name);
      setLayerColor(layer, color);
    }
    updateLegend();
    renderCompareTable();
  } else {
    if (currentSingle && currentSingle !== layer) resetLayer(currentSingle);
    currentSingle = layer;
    setLayerColor(layer, palette[0]);
    showDetails(name);
  }
}

// --- Panel UI ---
function showDetails(name){
  const d = complianceData[name];
  const el = document.getElementById('details');
  if (!d) {
    el.innerHTML = `<div class="jur-card"><h3>${name}</h3><p>No data available yet.</p></div>`;
  } else {
    el.innerHTML = `
      <div class="jur-card">
        <h3>${name}</h3>
        <p><strong>Authority:</strong> ${d.authority}</p>
        <p><strong>Law:</strong> ${d.law}</p>
        <p><strong>Transfers:</strong> ${d.transfers}</p>
        <p><strong>Fines:</strong> ${d.fines}</p>
        <p>${d.note || ''}</p>
      </div>`;
  }
}

// --- Compare panel + legend ---
function updateLegend(){
  const legend = document.getElementById('legend');
  legend.innerHTML = '';
  if (assignedOrder.length===0){ legend.innerHTML = '<div style="color:#666;font-size:13px">No comparisons selected.</div>'; return; }
  assignedOrder.forEach(name=>{
    const color = assigned[name];
    legend.innerHTML += `<div class="legend-item"><div class="swatch" style="background:${color}"></div><div>${name}</div></div>`;
  });
}
function renderCompareTable(){
  const el = document.getElementById('compareArea');
  if (assignedOrder.length===0){ el.textContent='No jurisdictions selected.'; return; }

  const fields=['authority','law','transfers','fines','note'];
  const labels={authority:'Authority',law:'Law',transfers:'Transfers',fines:'Fines',note:'Note'};
  let html='<table><thead><tr><th>Field</th>';
  assignedOrder.forEach(n=> html+=`<th style="color:${assigned[n]}">${n}</th>`);
  html+='</tr></thead><tbody>';
  fields.forEach(f=>{
    html+=`<tr><td><strong>${labels[f]}</strong></td>`;
    assignedOrder.forEach(n=>{
      const v=(complianceData[n]&&complianceData[n][f])||'';
      html+=`<td>${v}</td>`;
    });
    html+='</tr>';
  });
  html+='</tbody></table>';
  el.innerHTML=html;
}
function clearAll(){
  Object.keys(assigned).forEach(n=>resetLayer(layerByName[n]));
  assigned={}; assignedOrder=[];
  if (currentSingle){ resetLayer(currentSingle); currentSingle=null; }
  updateLegend(); renderCompareTable();
  document.getElementById('details').innerHTML='Click a country to view details.';
}

// --- Controls ---
document.getElementById('toggleCompare').onclick = () => {
  compareMode = !compareMode;
  const btn = document.getElementById('toggleCompare');
  btn.textContent = 'Compare Mode: ' + (compareMode ? 'ON' : 'OFF');
  btn.classList.toggle('active', compareMode);
  if (!compareMode) clearAll();
};
document.getElementById('clearAll').onclick = clearAll;

// init
updateLegend();
renderCompareTable();
</script>
</body>
</html>
