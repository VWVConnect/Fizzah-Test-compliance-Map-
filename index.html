<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GDPR Compliance Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    html,body { height:100%; margin:0; font-family:sans-serif; background:#ffffff; }
    #app { display:flex; height:100%; width:100%; }
    #map { flex:1; height:100%; background:#ffffff; cursor:pointer; }
    #panel { width:400px; border-left:1px solid #ccc; padding:10px; overflow-y:auto; background:#fff; }
    .jur-card { border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:10px; background:#fafafa; }
    table { border-collapse:collapse; width:100%; }
    th,td { border:1px solid #ddd; padding:6px; font-size:13px; }
    button { padding:6px 10px; margin:5px 3px; cursor:pointer; border:none; border-radius:4px; background:#222; color:#fff; }
    button.active { background:#555; }
  </style>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <div id="panel">
    <h2>GDPR Compliance Map</h2>
    <button id="modeToggle">Compare Mode: OFF</button>
    <div id="details">Click a country to view details.</div>
    <h3>Compare</h3>
    <div id="compare">No jurisdictions selected.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
// --- Compliance Data (demo) ---
const complianceData = {
  "France": { authority:"CNIL", law:"GDPR + French Data Protection Act", fines:"Up to €20M or 4%", transfers:"SCCs, adequacy", note:"Strong enforcement history" },
  "Germany": { authority:"BfDI / State DPAs", law:"GDPR + BDSG", fines:"Up to €20M or 4%", transfers:"SCCs; state rules", note:"State-level variation" },
  "United Kingdom": { authority:"ICO", law:"UK GDPR + DPA 2018", fines:"Up to £17.5M or 4%", transfers:"UK SCCs", note:"Post-Brexit adequacy" }
};

// --- Colors ---
const colors = ["#9b1e66","#e1345c","#e7450f","#f7a723","#ffd900","#4f9f35","#00a191"];

// --- Map setup ---
const map = L.map('map', {
  minZoom: 2,
  maxZoom: 2,
  zoomControl: false,
  dragging: true,
  doubleClickZoom: false,
  scrollWheelZoom: false,
  boxZoom: false,
  keyboard: false,
  tap: false,
  worldCopyJump: false,
  maxBounds: [[-40, -180], [75, 180]],
  maxBoundsViscosity: 1.0
}).setView([25, 10], 2);

// --- State ---
let compareMode = false;
const selected = [];
const colorAssignments = {};
let currentHighlight = null;

// --- Toggle Compare Mode ---
document.getElementById('modeToggle').onclick = function() {
  compareMode = !compareMode;
  this.textContent = `Compare Mode: ${compareMode ? 'ON' : 'OFF'}`;
  this.classList.toggle('active', compareMode);
  if (!compareMode) {
    renderCompare();
  }
};

// --- Load GeoJSON + Filter Small Islands ---
fetch('data/countries.geojson')
  .then(r => r.json())
  .then(geo => {
    const filteredFeatures = [];

    geo.features.forEach(f => {
      const name = f.properties.ADMIN || "";
      if (["Antarctica","Greenland"].includes(name)) return;

      if (f.geometry.type === "MultiPolygon") {
        const largePolys = f.geometry.coordinates.filter(coords => {
          const poly = turf.polygon(coords);
          const area = turf.area(poly);
          return area > 10000000000;
        });
        if (largePolys.length > 0) {
          filteredFeatures.push({
            type: "Feature",
            properties: f.properties,
            geometry: { type: "MultiPolygon", coordinates: largePolys }
          });
        }
      } else if (f.geometry.type === "Polygon") {
        const area = turf.area(f);
        if (area > 10000000000) filteredFeatures.push(f);
      }
    });

    const filtered = { type: "FeatureCollection", features: filteredFeatures };

    L.geoJSON(filtered, {
      style: baseStyle,
      onEachFeature: onEachCountry
    }).addTo(map);
  });

function baseStyle() {
  return { color:'#222', weight:1, fillColor:'#fdfdfd', fillOpacity:0.9 };
}

function onEachCountry(feature, layer){
  const name = feature.properties.ADMIN;
  layer.on({
    mouseover: e => e.target.setStyle({ fillOpacity:1 }),
    mouseout: e => e.target.setStyle({ fillOpacity:0.9 }),
    click: e => handleClick(name, layer)
  });
}

function handleClick(name, layer){
  if (compareMode) {
    handleCompareClick(name, layer);
  } else {
    handleSingleClick(name, layer);
  }
}

function handleSingleClick(name, layer){
  resetAllLayers();

  layer.setStyle({ fillColor: colors[0], fillOpacity: 1 });
  currentHighlight = layer;

  const data = complianceData[name];
  if (data){
    document.getElementById('details').innerHTML = `
      <div class="jur-card">
        <h3>${name}</h3>
        <p><strong>Authority:</strong> ${data.authority}</p>
        <p><strong>Law:</strong> ${data.law}</p>
        <p><strong>Transfers:</strong> ${data.transfers}</p>
        <p><strong>Fines:</strong> ${data.fines}</p>
        <p>${data.note}</p>
      </div>`;
  } else {
    document.getElementById('details').innerHTML = `<div class="jur-card"><h3>${name}</h3><p>No data yet.</p></div>`;
  }
}

function handleCompareClick(name, layer){
  if (selected.includes(name)) {
    selected.splice(selected.indexOf(name), 1);
    delete colorAssignments[name];
    layer.setStyle(baseStyle());
  } else if (selected.length < colors.length) {
    selected.push(name);
    const color = colors[selected.length - 1];
    colorAssignments[name] = color;
    layer.setStyle({ fillColor: color, fillOpacity: 1 });
  }
  renderCompare();
}

function resetAllLayers() {
  map.eachLayer(layer => {
    if (layer.setStyle) layer.setStyle(baseStyle());
  });
}

function renderCompare(){
  const compareEl = document.getElementById('compare');
  if (selected.length===0){ compareEl.textContent='No jurisdictions selected.'; return; }
  let html='<table><thead><tr><th>Field</th>';
  selected.forEach(n => html+=`<th style="color:${colorAssignments[n]}">${n}</th>`);
  html+='</tr></thead><tbody>';
  const fields=['authority','law','transfers','fines','note'];
  const labels={authority:'Authority',law:'Law',transfers:'Transfers',fines:'Fines',note:'Note'};
  fields.forEach(f=>{
    html+=`<tr><td><strong>${labels[f]}</strong></td>`;
    selected.forEach(n=> html+=`<td>${(complianceData[n]||{})[f]||''}</td>`);
    html+='</tr>';
  });
  html+='</tbody></table>';
  compareEl.innerHTML=html;
}
</script>
</body>
</html>

