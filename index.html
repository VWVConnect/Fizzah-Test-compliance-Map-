<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GDPR Compliance Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; background: #fff; font-family: system-ui, sans-serif; }
    #app { display: flex; height: 100%; width: 100%; }
    #map { flex: 1; background: #fff; cursor: pointer; }
    #panel { width: 380px; border-left: 1px solid #ccc; padding: 12px; overflow-y: auto; background: #fff; }
    h2 { margin-top: 0; }
    .jur-card { border: 1px solid #ddd; border-radius: 6px; padding: 8px; background: #fafafa; margin-bottom: 10px; }
    button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    button.active { background: #007bff; color: #fff; }
    .legend-item { display: flex; align-items: center; margin: 4px 0; gap: 6px; font-size: 14px; }
    .swatch { width: 18px; height: 14px; border: 1px solid #999; border-radius: 2px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 13px; }
  </style>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <div id="panel">
    <h2>GDPR Compliance Map</h2>
    <button id="toggleCompare">Compare Mode: OFF</button>
    <button id="clearAll" style="margin-left:10px;">Clear</button>
    <div id="details" class="jur-card" style="margin-top:10px;">Click a country to view details.</div>
    <div id="legend"></div>
    <h3>Comparison</h3>
    <div id="compareArea">No jurisdictions selected.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
const complianceData = {
  "France": { authority:"CNIL", law:"GDPR + French Data Protection Act", fines:"Up to €20M or 4%", transfers:"SCCs, adequacy", note:"Strong enforcement history" },
  "Germany": { authority:"BfDI / State DPAs", law:"GDPR + BDSG", fines:"Up to €20M or 4%", transfers:"SCCs; state rules", note:"State-level variation" },
  "United Kingdom": { authority:"ICO", law:"UK GDPR + DPA 2018", fines:"Up to £17.5M or 4%", transfers:"UK SCCs", note:"Post-Brexit adequacy" }
};

const colors = ["#9b1e66","#e1345c","#e7450f","#f7a723","#ffd900","#4f9f35","#00a191"];
let compareMode = false;
let selected = {};
let order = [];
let current = null;
let layerMap = {};

const map = L.map('map', {
  zoomControl:false,
  scrollWheelZoom:false,
  doubleClickZoom:false,
  dragging:true,
  maxBounds:[[-40,-180],[75,180]],
  maxBoundsViscosity:1.0
}).setView([25,10],2);

function baseStyle(){ return { color:'#222', weight:1, fillColor:'#fdfdfd', fillOpacity:1, className:'country' }; }
function setColor(layer,color){ layer.setStyle({ fillColor:color, fillOpacity:1 }); layer.bringToFront(); }
function resetColor(layer){ layer.setStyle(baseStyle()); }

fetch('countries.geojson')
  .then(r=>r.json())
  .then(data=>{
    // filter out Antarctica & tiny islands
    data.features = data.features.filter(f=>{
      const props = f.properties || {};
      const name = props.ADMIN || props.NAME || props.name_long || props.name || "Unknown";
      if (name === "Antarctica") return false;
      if (f.bbox){
        const w = Math.abs(f.bbox[2]-f.bbox[0]);
        const h = Math.abs(f.bbox[3]-f.bbox[1]);
        const area = w*h;
        if (area < 5) return false; // stricter filter removes most islands
      }
      // remove known small island states
      const exclude = [
        "Tuvalu","Nauru","Palau","Marshall Islands","Micronesia",
        "Seychelles","Maldives","Saint Kitts and Nevis","Saint Vincent and the Grenadines",
        "Saint Lucia","Dominica","Antigua and Barbuda","Samoa","Tonga",
        "Kiribati","Comoros","Vanuatu","Cape Verde","Barbados","Grenada"
      ];
      if (exclude.includes(name)) return false;
      return true;
    });

    L.geoJSON(data,{
      style:baseStyle,
      onEachFeature:(feature,layer)=>{
        const props = feature.properties || {};
        const name = props.ADMIN || props.NAME || props.name_long || props.name || "Unknown";
        layerMap[name]=layer;
        layer.on('click',()=>handleClick(name));
        layer.on('mouseover',()=>layer.setStyle({ fillOpacity:0.9 }));
        layer.on('mouseout',()=>{
          if (!selected[name] && layer!==current) resetColor(layer);
        });
      }
    }).addTo(map);
  })
  .catch(err=>console.error("GeoJSON load error:", err));

document.getElementById('toggleCompare').onclick=()=>{
  compareMode=!compareMode;
  const btn=document.getElementById('toggleCompare');
  btn.textContent='Compare Mode: '+(compareMode?'ON':'OFF');
  btn.classList.toggle('active',compareMode);
  if(!compareMode){ clearAll(); }
};
document.getElementById('clearAll').onclick=clearAll;

function handleClick(name){
  const layer=layerMap[name];
  if(!layer)return;

  if(compareMode){
    if(selected[name]){
      delete selected[name];
      order=order.filter(n=>n!==name);
      resetColor(layer);
    }else{
      const used=new Set(Object.values(selected));
      const color=colors.find(c=>!used.has(c));
      if(!color)return alert('Max comparisons reached.');
      selected[name]=color;
      order.push(name);
      setColor(layer,color);
    }
    updateLegend();
    renderCompare();
  }else{
    if(current && current!==layer)resetColor(current);
    current=layer;
    setColor(layer,colors[0]);
    showDetails(name);
  }
}

function showDetails(name){
  const d=complianceData[name];
  const el=document.getElementById('details');
  if(!d){ el.innerHTML=`<div class="jur-card"><h3>${name}</h3><p>No data yet.</p></div>`; }
  else{
    el.innerHTML=`
      <div class="jur-card">
        <h3>${name}</h3>
        <p><b>Authority:</b> ${d.authority}</p>
        <p><b>Law:</b> ${d.law}</p>
        <p><b>Transfers:</b> ${d.transfers}</p>
        <p><b>Fines:</b> ${d.fines}</p>
        <p>${d.note||''}</p>
      </div>`;
  }
}

function updateLegend(){
  const el=document.getElementById('legend');
  el.innerHTML='';
  order.forEach(n=>{
    const color=selected[n];
    el.innerHTML+=`<div class="legend-item"><div class="swatch" style="background:${color}"></div>${n}</div>`;
  });
  if(order.length===0)el.innerHTML='<div style="color:#666;">No jurisdictions selected.</div>';
}

function renderCompare(){
  const el=document.getElementById('compareArea');
  if(order.length===0){ el.textContent='No jurisdictions selected.'; return; }
  const fields=['authority','law','transfers','fines','note'];
  const labels={authority:'Authority',law:'Law',transfers:'Transfers',fines:'Fines',note:'Note'};
  let html='<table><thead><tr><th>Field</th>';
  order.forEach(n=>html+=`<th style="color:${selected[n]}">${n}</th>`);
  html+='</tr></thead><tbody>';
  fields.forEach(f=>{
    html+=`<tr><td><b>${labels[f]}</b></td>`;
    order.forEach(n=>{
      const v=(complianceData[n]&&complianceData[n][f])||'';
      html+=`<td>${v}</td>`;
    });
    html+='</tr>';
  });
  html+='</tbody></table>';
  el.innerHTML=html;
}

function clearAll(){
  Object.keys(selected).forEach(n=>resetColor(layerMap[n]));
  selected={};order=[];
  if(current){resetColor(current);current=null;}
  updateLegend();
  renderCompare();
  document.getElementById('details').textContent='Click a country to view details.';
}
</script>
</body>
</html>



