<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
const colors = ["#7fc28f","#07b0a0","#00a6c5","#ffd900","#4f9f35","#9b1e66"];
let complianceData = {};
let layerMap={}, selected={}, order=[], current=null, compareMode=false;

// ðŸ”¹ Load World Bank data (Internet users %)
async function loadLiveData() {
  const indicator = "IT.NET.USER.ZS";
  let page = 1, pages = 1, all = [];
  while (page <= pages) {
    const res = await fetch(`https://api.worldbank.org/v2/country/all/indicator/${indicator}?format=json&per_page=1000&page=${page}`);
    const json = await res.json();
    if (!json[1]) break;
    pages = json[0].pages;
    all = all.concat(json[1]);
    page++;
  }
  all.forEach(d => {
    const c = d.country?.value;
    const v = d.value;
    if (!c || v == null) return;
    complianceData[c] = {
      authority: "â€”",
      law: "â€”",
      transfers: "â€”",
      fines: "â€”",
      note: `Internet users: ${v.toFixed(1)}%`
    };
  });
  console.log("âœ… Loaded data for", Object.keys(complianceData).length, "countries");
}

// ðŸ”¹ Map color logic
function getColorByValue(v) {
  if (v > 90) return colors[5];
  if (v > 70) return colors[4];
  if (v > 50) return colors[2];
  if (v > 30) return colors[1];
  if (v > 10) return colors[0];
  return colors[3];
}

function extractValue(name){
  const note = complianceData[name]?.note || '';
  const match = note.match(/([\d.]+)/);
  return match ? parseFloat(match[1]) : 0;
}

// ðŸ”¹ Initialize map and UI
window.addEventListener("load", async () => {
  const map = L.map('map', { zoomControl:false }).setView([20,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  await loadLiveData();

  const jurisdictionSelect = document.getElementById('jurisdictionSelect');

  // Load your GitHub-hosted GeoJSON
  const geo = await fetch('https://vwvconnect.github.io/Fizzah-Test-compliance-Map-/countries.geojson').then(r=>r.json());
  geo.features = geo.features.filter(f=>f.properties.ADMIN !== "Antarctica").sort((a,b)=>a.properties.ADMIN.localeCompare(b.properties.ADMIN));

  // Populate dropdown
  geo.features.forEach(f=>{
    const name=f.properties.ADMIN;
    const opt=document.createElement('option');
    opt.value=name; opt.textContent=name;
    jurisdictionSelect.appendChild(opt);
  });

  // Draw countries
  L.geoJSON(geo, {
    style: f=>{
      const name=f.properties.ADMIN;
      const val=extractValue(name);
      return {color:'#192543', weight:1, fillColor:getColorByValue(val), fillOpacity:0.9};
    },
    onEachFeature:(f,layer)=>{
      const name=f.properties.ADMIN;
      layerMap[name]=layer;
      layer.on('click',()=>handleClick(name));
    }
  }).addTo(map);

  jurisdictionSelect.addEventListener('change', e=>{
    const n=e.target.value;
    if(n && layerMap[n]) handleClick(n);
  });

  document.getElementById('toggleCompare').addEventListener('change', function(){
    compareMode=this.checked;
    document.getElementById('compareArea').classList.toggle('hidden',!compareMode);
    document.getElementById('compareTitle').classList.toggle('hidden',!compareMode);
    if(compareMode && current){
      const name=Object.keys(layerMap).find(n=>layerMap[n]===current);
      if(name && !selected[name]) addToSelection(name);
      document.getElementById('details').classList.add('hidden');
      renderCompare();
    } else { document.getElementById('details').classList.remove('hidden'); }
    if(!compareMode) clearAll();
  });

  document.getElementById('clearAll').onclick=clearAll;

  function addToSelection(name){
    const val = extractValue(name);
    const color = getColorByValue(val);
    selected[name]=color; order.push(name);
    layerMap[name].setStyle({fillColor:color});
  }

  function handleClick(name){
    const layer=layerMap[name]; if(!layer) return;
    const val=extractValue(name); const color=getColorByValue(val);
    if(compareMode){
      if(selected[name]){ delete selected[name]; order=order.filter(n=>n!==name); layer.setStyle({fillColor:getColorByValue(val)}); }
      else addToSelection(name);
      document.getElementById('details').classList.add('hidden');
    } else {
      if(current && current!==layer) current.setStyle({fillColor:getColorByValue(extractValue(Object.keys(layerMap).find(k=>layerMap[k]===current)))});
      current=layer;
      layer.setStyle({fillColor:color});
      document.getElementById('details').classList.remove('hidden');
      showDetails(name);
    }
    jurisdictionSelect.value=name;
    renderCompare();
  }

  function showDetails(name){
    const d=complianceData[name];
    const el=document.getElementById('details');
    el.innerHTML=d ? `<h3>${name}</h3>
       <p><strong>Authority:</strong> ${d.authority}</p>
       <p><strong>Law:</strong> ${d.law}</p>
       <p><strong>Transfers:</strong> ${d.transfers}</p>
       <p><strong>Fines:</strong> ${d.fines}</p>
       <p class="note">${d.note}</p>` : `<h3>${name}</h3><p>No data available.</p>`;
  }

  function renderCompare(){
    const el=document.getElementById('compareArea');
    if(order.length===0){ el.innerHTML=''; return; }
    const fields=['authority','law','transfers','fines','note'];
    const labels={authority:'Authority',law:'Law',transfers:'Transfers',fines:'Fines',note:'Notes'};
    let html='<table><thead><tr><th class="blank"></th>';
    fields.forEach(f=>html+=`<th class="field">${labels[f]}</th>`);
    html+='</tr></thead><tbody>';
    order.forEach(c=>{
      const color=selected[c];
      html+=`<tr><td class="country" style="background:${color}">${c}</td>`;
      fields.forEach(f=>html+=`<td>${complianceData[c]?.[f]||''}</td>`);
      html+='</tr>';
    });
    html+='</tbody></table>';
    el.innerHTML=html;
  }

  function clearAll(){
    Object.keys(selected).forEach(n=>{
      const val=extractValue(n);
      layerMap[n].setStyle({fillColor:getColorByValue(val)});
    });
    selected={}; order=[]; if(current){ current=null; }
    renderCompare();
    document.getElementById('details').textContent='Select a country to view details.';
    jurisdictionSelect.value='';
  }
});
</script>
