<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GDPR Compliance Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    html,body { height:100%; margin:0; font-family:sans-serif; background:#ffffff; }
    #app { display:flex; height:100%; width:100%; }
    #map { flex:1; height:100%; background:#ffffff; cursor:pointer; }
    #panel { width:400px; border-left:1px solid #ccc; padding:10px; overflow-y:auto; background:#fff; }
    .jur-card { border:1px solid #ddd; border-radius:6px; padding:8px; margin-bottom:10px; background:#fafafa; }
    table { border-collapse:collapse; width:100%; }
    th,td { border:1px solid #ddd; padding:6px; font-size:13px; }
    button { padding:6px 10px; margin:5px 3px; cursor:pointer; border:none; border-radius:4px; background:#222; color:#fff; }
    button.active { background:#555; }
  </style>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <div id="panel">
    <h2>GDPR Compliance Map</h2>
    <button id="modeToggle">Compare Mode: OFF</button>
    <div id="details">Click a country to view details.</div>
    <h3>Compare</h3>
    <div id="compare">No jurisdictions selected.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
// --- Demo compliance data ---
const complianceData = {
  "France": { authority:"CNIL", law:"GDPR + French Data Protection Act", fines:"Up to €20M or 4%", transfers:"SCCs, adequacy", note:"Strong enforcement history" },
  "Germany": { authority:"BfDI / State DPAs", law:"GDPR + BDSG", fines:"Up to €20M or 4%", transfers:"SCCs; state rules", note:"State-level variation" },
  "United Kingdom": { authority:"ICO", law:"UK GDPR + DPA 2018", fines:"Up to £17.5M or 4%", transfers:"UK SCCs", note:"Post-Brexit adequacy" }
};

// --- Color sequence for comparisons ---
const colorPalette = ["#9b1e66","#e1345c","#e7450f","#f7a723","#ffd900","#4f9f35","#00a191"];

// --- Map setup ---
const map = L.map('map', {
  zoomControl: false,
  doubleClickZoom: false,
  scrollWheelZoom: false,
  boxZoom: false,
  keyboard: false,
  dragging: true,
  minZoom: 2,
  maxZoom: 2,
  worldCopyJump: false,
  maxBounds: [[-40, -180], [75, 180]],
  maxBoundsViscosity: 1.0
}).setView([25, 10], 2);

// --- State tracking ---
let compareMode = false;
let selectedCountries = [];
let countryLayers = {}; // name -> Leaflet layer
let colorAssignments = {}; // name -> hex color
let currentHighlight = null;

// --- Toggle compare mode ---
const toggleBtn = document.getElementById('modeToggle');
toggleBtn.onclick = () => {
  compareMode = !compareMode;
  toggleBtn.textContent = `Compare Mode: ${compareMode ? 'ON' : 'OFF'}`;
  toggleBtn.classList.toggle('active', compareMode);

  if (!compareMode) {
    // Reset compare colors
    selectedCountries.forEach(name => {
      if (countryLayers[name]) countryLayers[name].setStyle(baseStyle());
    });
    selectedCountries = [];
    colorAssignments = {};
    renderCompare();
  }
};

// --- Base style ---
function baseStyle() {
  return { color:'#222', weight:1, fillColor:'#fdfdfd', fillOpacity:0.9 };
}

// --- Load GeoJSON ---
fetch('countries.geojson')
  .then(r => r.json())
  .then(geo => {
    const filtered = { type: "FeatureCollection", features: [] };
    geo.features.forEach(f => {
      const name = f.properties.ADMIN || "";
      if (["Antarctica","Greenland"].includes(name)) return;

      const area = turf.area(f);
      if (area > 10000000000) filtered.features.push(f);
    });

    L.geoJSON(filtered, {
      style: baseStyle,
      onEachFeature: (feature, layer) => {
        const name = feature.properties.ADMIN;
        countryLayers[name] = layer;

        layer.on('mouseover', () => layer.setStyle({ fillOpacity: 1 }));
        layer.on('mouseout', () => {
          if (!isCountrySelected(name)) layer.setStyle({ fillOpacity: 0.9 });
        });

        layer.on('click', () => handleCountryClick(name));
      }
    }).addTo(map);
  });

// --- Helpers ---
function isCountrySelected(name) {
  return selectedCountries.includes(name);
}

function handleCountryClick(name) {
  const layer = countryLayers[name];
  if (!layer) return;

  if (compareMode) {
    if (isCountrySelected(name)) {
      // Deselect
      selectedCountries = selectedCountries.filter(n => n !== name);
      delete colorAssignments[name];
      layer.setStyle(baseStyle());
    } else if (selectedCountries.length < colorPalette.length) {
      // Add with color
      const color = colorPalette[selectedCountries.length];
      selectedCountries.push(name);
      colorAssignments[name] = color;
      layer.setStyle({ fillColor: color, fillOpacity: 1, color:'#222', weight:1 });
    }
    renderCompare();
  } else {
    // Single select mode
    if (currentHighlight) currentHighlight.setStyle(baseStyle());
    currentHighlight = layer;
    layer.setStyle({ fillColor: colorPalette[0], fillOpacity: 1, color:'#222', weight:1 });
    showCountryDetails(name);
  }
}

function showCountryDetails(name) {
  const d = complianceData[name];
  const el = document.getElementById('details');
  if (!d) {
    el.innerHTML = `<div class="jur-card"><h3>${name}</h3><p>No data yet.</p></div>`;
  } else {
    el.innerHTML = `
      <div class="jur-card">
        <h3>${name}</h3>
        <p><strong>Authority:</strong> ${d.authority}</p>
        <p><strong>Law:</strong> ${d.law}</p>
        <p><strong>Transfers:</strong> ${d.transfers}</p>
        <p><strong>Fines:</strong> ${d.fines}</p>
        <p>${d.note}</p>
      </div>`;
  }
}

function renderCompare() {
  const compareEl = document.getElementById('compare');
  if (selectedCountries.length === 0) {
    compareEl.textContent = 'No jurisdictions selected.';
    return;
  }

  let html = '<table><thead><tr><th>Field</th>';
  selectedCountries.forEach(name => {
    html += `<th style="color:${colorAssignments[name]}">${name}</th>`;
  });
  html += '</tr></thead><tbody>';

  const fields = ['authority','law','transfers','fines','note'];
  const labels = {authority:'Authority',law:'Law',transfers:'Transfers',fines:'Fines',note:'Note'};

  fields.forEach(field => {
    html += `<tr><td><strong>${labels[field]}</strong></td>`;
    selectedCountries.forEach(name => {
      const value = (complianceData[name] || {})[field] || '';
      html += `<td>${value}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  compareEl.innerHTML = html;
}
</script>
</body>
</html>


